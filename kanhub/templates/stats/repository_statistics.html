{% extends "base.html" %}
{% load i18n %}

{% load static %}

{% block title %}{{ repository.name }}{% endblock %}

{% block content %}

<div class="container mt-4">
  {% include "includes/header_of_repo.html" %}

  <h1>Статистика репозитория: {{ repository.name }}</h1>

  <div class="statistics">
    <h2>Общая информация</h2>
    <p>Количество коммитов: {{ commits_count }}</p>
    <p>Количество задач: {{ tasks_count }}</p>
    {% if latest_commit %}
    <p>Последний коммит: {{ latest_commit.name }} ({{ latest_commit.created_at }})</p>
    {% else %}
    <p>Нет коммитов</p>
    {% endif %}
  </div>

  <div class="tasks-by-tags">
    <h2>Задачи по тегам</h2>
    <ul>
      {% for tag in tasks_by_tags %}
      <li>{{ tag.tags__name }}: {{ tag.count }}</li>
      {% empty %}
      <li>Нет задач с тегами</li>
      {% endfor %}
    </ul>
  </div>

  <div class="chart">
    <h2>График задач по тегам</h2>
    <canvas id="tasksChart" width="400" height="200"></canvas>
  </div>

</div>

<link href="{% static 'css/stats.css' %}" rel="stylesheet">
<script src="{% static 'js/chart.js' %}"></script>
<script>
  const labels = [
  {% for tag in tasks_by_tags %}
  "{{ tag.tags__name }}",
  {% endfor %}
  ];

  const data = {
  labels: labels,
  datasets: [{
    label: "Количество задач по тегам",
    data: [
      {% for tag in tasks_by_tags %}
      {{ tag.count }},
      {% endfor %}
    ],
    backgroundColor: [
      'rgba(255, 99, 132, 0.2)',
      'rgba(54, 162, 235, 0.2)',
      'rgba(255, 206, 86, 0.2)',
      'rgba(75, 192, 192, 0.2)',
      'rgba(153, 102, 255, 0.2)',
      'rgba(255, 159, 64, 0.2)'
    ],
    borderColor: [
      'rgba(255, 99, 132, 1)',
      'rgba(54, 162, 235, 1)',
      'rgba(255, 206, 86, 1)',
      'rgba(75, 192, 192, 1)',
      'rgba(153, 102, 255, 1)',
      'rgba(255, 159, 64, 1)'
    ],
    borderWidth: 1
  }]
  };

  const config = {
  type: 'bar',
  data: data,
  options: {
    scales: {
      y: {
        beginAtZero: true
      }
    },
    responsive: true,
    maintainAspectRatio: false
  }
  };

  const tasksChart = new Chart(
  document.getElementById('tasksChart'),
  config
  );
</script>

{% endblock %}
